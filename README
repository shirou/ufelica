* これはなに？

Pasori(SC-R310)を利用して、Felicaカードが持つ固有IDを読み取るプログラ
ムです。

(製品Webページ: http://www.so-net.ne.jp/shopping/edy/pasori.html)

----
* 注意

カードが持つ固有IDのみを読み取ります。ただし、カード自体に記載されてい
るIDではなく、 *おそらく* IDだろうと思われるバイト列を読み出します。この
バイト列はチャージをしても変化しないことは確認しておりますが、実際のID
でない可能性もありえます。

ただしSuikaとEdyでプロトコルが違うことから、felica 自体のIDではなく、
その上のアプリケーションが管理しているIDなのだと思われます。

また、カード内へのデータの書込、カード内データの読み取りなどの機能はあ
りません。付けるつもりもありません。(書き込みはおそらくできませんが…)


----
* 使用例

まずカードを置きます。その後、EdyカードのIDを読むのならば

  % ufelica -t 0

Suica/ICOCAのIDを読むのならば

  % ufelica -t 1

として実行します。だいたいの場合ではroot権限が必要になります。
Edyの場合は、単にufelicaと実行するだけでも大丈夫です。

出力は標準出力に出されるので、

  % ufelica | blah.sh

として、お好きなスクリプトなりなんなりをかましてください。

標準出力を利用する場合は、-l オプションを付けて、loop modeで実行した方
がよいでしょう。

ただし、カードが置かれていない時にはエラー(0000000000など)も出力されて
しまうため、スクリプト側で回避してください。(さすがにださいので変更す
る予定)


----
* オプションの解説

-v : 冗長なメッセージがでます。
     get_idで取れるID列は実際には24byteなのですが、
     通常はそのうちの13byteのみ表示します。
     -v オプションをつけると、全てのbyteを表示するようになります。
-V : バージョンを表示します。ただ、バージョン管理はいい加減です :-P
-l : loop modeです。1秒に一回読みにいきます。これをつけないと一回読み
     にいって終わりになります。
-t <type id> :
     送信するメッセージの種類を決定します。
     現在分かっているのは Edyと Suica/ICOCAだけです。
     それ以外のメッセージは未解析です。また、解析する気はありません。

----
* How To Build

** 共通

make には gnu make(gmake)を使用してください。

** Linux

libusb(http://libusb.sourceforge.net/)が必要です。事前にインストールし
てください。

展開したディレクトリでmakeと打つと場合によってはufelicaという実行
ファイルができます。

** Windows

buildにはcygwinが必要です。また、Windowsでは、
http://libusb-win32.sourceforge.net/ のほうが必要です。

libusb-win32-filter-binのほうをdonwloadし、src付きでインストールしてお
きます。

その後、ufelica.tar.gzをProgramfiles/libusb-win/src/の下において展開し
てください。

展開したディレクトリの中でmakeとうつと運がよければufelica.exeが作成されます。

また、Windowsで動作させるためには、

http://www.sony.co.jp/Products/felica/pcrw/index.html

からドライバをダウンロードし、インストールする必要があります。

** *BSD

残念ながらFreeBSDおよびNetBSDでの動作は(現在のところ)できません。

read システムコールを呼出した時点で返答がなくなります。

おそらくugenの実装に関して問題があるのではないかと思いますが、追求しき
れてませんので、どなたか手伝ってくださるとうれしいです。


----
* 動作確認済カード

- Suica/ICOCA
- Edy

ただし、一番最初のEdyカード("Edy!"と!が入っている)は認識しませんでした。

----
* 注意点

EdyのIDを読む場合とSuicaのIDを読む場合とでは、どうやらプロトコルが異な
るようです。-t オプションで変更可能です。

また、それ以外にも多くのコマンドを送り込むことができますが、どのような
コマンドなのかは把握しておりません。また、ufelicaの目的はIDをとること
だけなのでそれ以外のコマンドを追求する気はありません。御了承ください。


----
* ライセンス

修正BSDライセンス

----
* ChangeLog


- 2004-08-04 version 0.1.2リリース

-s でsleepする秒を設定できるようにした。

- 2004-08-04 version 0.1.1リリース

標準では9byteを表示していたが、10byte(20桁)に変えてみた。あまり意味はな
いかもしれない。

また、さらにスクリプトで使いやすくするために、loopモードでは、
- 読み込みエラーメッセージは表示されない (読めないと0000が返るはず)
- 10byte分はそのまま書かれる(空白がない)

としてみた。

あと、0.0.?だと、細かな変更とかをバージョン番号に入れられないので一気
に0.1まであげてみた。0.1.0は幻。

- 2004-08-02 version 0.0.4

  新しいPaSoRiリーダは、最初にリーダの初期化をしなければいけないこと
  がわかったため、INITコマンドをを追加し、
  ufelica_pasori_initalize()関数を追加した。
  INITを発行した後readをしなければいけないのにつまづいた。

  ついでに、-vをつけないと、IDだけしかでないようにものすごくシンプル
  にした。これでスクリプトに噛ませやすくなったはず。

- 2004-06-07 18:44:06 0.0.3リリース

  - loop modeを追加
  - fflushを加えてきちんと標準出力に出すように変更
  - 通常表示するIDを13桁に制限
  - makeでOSを判別するように変更 (その代わりgnu make に変更)

- 2004-05-21 19:55:05 0.0.2リリース

  - -t オプションでコマンドを変更可能に

- 2004-04-21 02:06:04  0.0.1リリース
